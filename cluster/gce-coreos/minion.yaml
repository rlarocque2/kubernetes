
#  ### Hard-coded fragment begins here. ###
#
# This section should be preceded with another fragment that contains
# something like the following to make the merge-key below work:
#
#   etcd-params-for-merge-key: &peer-list
#     peers: 1.2.3.4:7001,4.5.6.7:7001

coreos:
  etcd:
    <<: *peer-list
    addr: $private_ipv4:4001
    peer-addr: $private_ipv4:7001

  fleet:
    metadata: region=us-west,role=master

  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start

    - name: kubernetes-install-minion.service
      command: start
      content: |
        [Unit]
        Description=Install Kubernetes Server
        Requires=network-online.target
        After=network-online.target
        Requires=kubernetes-minion-params.service
        After=kubernetes-minion-params.service

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        EnvironmentFile=/etc/kubernetes-minion-params
        ExecStartPre=/usr/bin/mkdir -p /opt/kubernetes/pkg
        ExecStartPre=/usr/bin/curl --location --create-dirs --output /opt/kubernetes/pkg/kubernetes-server-linux-amd64.tar.gz ${SERVER_BINARY_TAR_URL}
        ExecStart=/usr/bin/tar xf /opt/kubernetes/pkg/kubernetes-server-linux-amd64.tar.gz -C /opt --overwrite

    - name: kubernetes-minion-params.service
      command: start
      content: |
        [Unit]
        Description=Fetch kubernetes-minion-params
        Requires=network-online.target
        After=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/curl --fail --silent --show-error \
        -H "X-Google-Metadata-Request: True" \
        -o /etc/kubernetes-minion-params \
        http://169.254.169.254/computeMetadata/v1/instance/attributes/kubernetes-minion-params

    - name: kubelet.service
      command: start
      content: |
        [Unit]
        Description=Kubelet
        Requires=kubernetes-install-minion.service
        After=kubernetes-install-minion.service
        Requires=kubernetes-minion-params.service
        After=kubernetes-minion-params.service

        [Service]
        EnvironmentFile=/etc/kubernetes-minion-params
        ExecStart=/opt/kubernetes/server/bin/kubelet \
        --etcd_servers=http://${KUBE_MASTER_INTERNAL_IP}:4001 \
        --api_servers=http://${KUBE_MASTER_INTERNAL_IP}:8080 \
        --address=0.0.0.0 \
        --config=/etc/kubernetes/manifests \
        --allow_privileged=false \
        --logtostderr=true

    - name: kube-proxy.service
      command: start
      content: |
        [Unit]
        Description=Kubelet
        Requires=kubernetes-install-minion.service
        After=kubernetes-install-minion.service
        Requires=kubernetes-minion-params.service
        After=kubernetes-minion-params.service

        [Service]
        EnvironmentFile=/etc/kubernetes-minion-params
        ExecStart=/opt/kubernetes/server/bin/kube-proxy \
        --etcd_servers=http://${KUBE_MASTER_INTERNAL_IP}:4001 \
        --master=http://${KUBE_MASTER_INTERNAL_IP}:8080 \
        --logtostderr=true